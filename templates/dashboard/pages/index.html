{% extends 'dashboard/layout/main.html' %}

{% block title %}
{{ block.super }} - Index
{% endblock %}

{% block content %}
<h2 class="text-xl font-semibold mb-4">Dashboard Index Page</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 shadow rounded-lg">
        <h3 class="text-lg font-semibold">Total Sales</h3>
        <p class="text-xl">NPR {{ total_sales }}</p>
    </div>
    <div class="bg-white p-4 shadow rounded-lg">
        <h3 class="text-lg font-semibold">Total Transactions</h3>
        <p class="text-xl">NPR {{ total_transaction }}</p>
    </div>
    <div class="bg-white p-4 shadow rounded-lg">
        <h3 class="text-lg font-semibold">Pending Amount</h3>
        <p class="text-xl">NPR {{ total_pending_amount }}</p>
    </div>
    <div class="bg-white p-4 shadow rounded-lg">
        <h3 class="text-lg font-semibold">New Customers</h3>
        <p class="text-xl">{{ new_customers }}</p>
    </div>
</div>

<div class="grid grid-cols-2  gap-x-4    ">
    <div class="bg-white p-6 shadow rounded-lg mb-6 col-span-2 h-[60vh]">
        <h3 class="text-lg font-semibold mb-4">Sales Chart</h3>
        <div id="salesChart"></div>
    </div>

    <div class="bg-white p-6 shadow rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-4">Transaction Chart</h3>
        <div id="transactionChart"></div>
    </div>

    <div class="bg-white p-6 shadow rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-4">Top Perfoming Product</h3>
        <div id="topSoldProduct"></div>
    </div>
</div>

<div id="backendPassedData" style="display: none;">{{ sales_data }}</div>
<div id="backendTransactionPassedData" style="display: none;">{{ transaction_data }}</div>

<div id="backendTopProductsData" style="display: none;">{{ top_products_data }}</div>




<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script id="sales-data" type="application/json">{{ sales_values|json_script:"sales-data" }}</script>
<script id="sales-categories" type="application/json">{{ sales_categories|json_script:"sales-categories" }}</script>

<script id="transaction-data" type="application/json">{{ transaction_values|json_script:"transaction-data" }}</script>
<script id="transaction-categories" type="application/json">{{ transaction_categories|json_script:"transaction-categories" }}</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get the div element by id
        var backendPassedDataDiv = document.getElementById('backendPassedData');

        // Get the inner text content of the div (which contains your JSON data)
        var salesDataJson = backendPassedDataDiv.textContent.trim();

        // Parse the JSON data into a JavaScript object
        var backendData = JSON.parse(salesDataJson);

        // Define months in the correct order
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // Initialize sales data array with zeros for all months
        var sales = months.map(function (month) {
            var foundItem = backendData.find(function (item) {
                return item.month === month;
            });
            return foundItem ? foundItem.sales : 0;
        });

        // Example: Update your chart options with both sales and months
        var options = {
            series: [
                {
                    name: "Sales",
                    data: sales
                }
            ],
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight'
            },
            title: {
                text: 'Product Trends by Month',
                align: 'left'
            },
            grid: {
                row: {
                    colors: ['#f3f3f3', 'transparent'],
                    opacity: 0.5
                },
            },
            xaxis: {
                categories: months
            }
        };

        // Render the chart using ApexCharts
        var chart = new ApexCharts(document.querySelector("#salesChart"), options);
        chart.render();
    

    var backendTransactionPassedDataDiv = document.getElementById('backendTransactionPassedData');
    var transactionDataJson = backendTransactionPassedDataDiv.textContent.trim();
    var backendTransactionData = JSON.parse(transactionDataJson);

        var transactions = months.map(function (month) {
            var foundItem = backendTransactionData.find(function (item) {
                return item.month === month;
            });
            return foundItem ? foundItem.transactions : 0;
        });

        var transactionOptions = {
            series: [{
                name: "Transaction",
                data: transactions
            }],
            chart: {
                height: 350,
                type: 'line',
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'straight'
            },
            title: {
                text: 'Product Trends by Month',
                align: 'left'
            },
            grid: {
                row: {
                    colors: ['#f3f3f3', 'transparent'],
                    opacity: 0.5
                },
            },
            xaxis: {
                categories: months
            }
        };

        var transactionChart = new ApexCharts(document.querySelector("#transactionChart"), transactionOptions);
        transactionChart.render();
        var backendTopProductsDataDiv = document.getElementById('backendTopProductsData');
        if (backendTopProductsDataDiv) {
            var topProductsDataJson = backendTopProductsDataDiv.textContent.trim();
            var topProductsData = JSON.parse(topProductsDataJson);
            
            console.log('Top Products Data:', topProductsData);  // Debug statement

            var topProductsOptions = {
                chart: {
                    type: 'donut'
                },
                series: topProductsData.values,
                labels: topProductsData.labels,
                xaxis: {
                    categories: topProductsData.labels // assuming you want to show labels as categories
                }
            };

            var topProductsChart = new ApexCharts(document.querySelector("#topSoldProduct"), topProductsOptions);
            topProductsChart.render();
        } else {
            console.error('No data found for top products');
        }
    });
</script>


{% endblock %}